# AlignmentSimulator

This script is a high-performance tool for simulating large, concatenated DNA sequence alignments (supermatrices). It leverages the `pyvolve` library for sequence evolution and Python's `multiprocessing` module to dramatically accelerate simulations on multi-core systems.

The primary use case is for generating datasets under specific evolutionary models, such as creating a null-hypothesis dataset (i.e., evolution without gene flow) for downstream hypothesis testing in phylogenomics.

The script offers two convenient modes of operation:
-   **Automatic Mode**: Directly parses the GTR+GAMMA substitution model parameters from a `RAxML` info/log file.
-   **Manual Mode**: Uses substitution model parameters provided by the user in a simple JSON file format.

---

## Table of Contents
- [Key Features](#key-features)
- [Dependencies](#dependencies)
- [Installation](#installation)
- [Usage](#usage)
  - [Automatic Mode Example](#automatic-mode-example)
  - [Manual Mode Example](#manual-mode-example)
- [Modes of Operation Explained](#modes-of-operation-explained)
  - [Automatic Mode (-i)](#automatic-mode--i)
  - [Manual Mode (-p)](#manual-mode--p)
- [Command-Line Options](#command-line-options)
- [Input Files](#input-files)
  - [RAxML Info File](#raxml-info-file)
  - [Custom Parameters JSON File](#custom-parameters-json-file)
  - [Tree File](#tree-file)
- [Output File](#output-file)

---

## Key Features

-   **Parallel Processing**: Utilizes multiple CPU cores (`-j` option) to run simulation chunks simultaneously, significantly reducing the time required to generate large datasets.
-   **Automatic Parameter Extraction**: In automatic mode, the script intelligently parses all necessary GTR+GAMMA model parameters (alpha, base frequencies, substitution rates) from a standard RAxML output file.
-   **Failsafe Template Generation**: If automatic parsing of a RAxML file fails, the script generates a `params_template.json` file, which the user can manually edit and use with manual mode.
-   **Flexible Manual Control**: Manual mode allows users to specify custom model parameters via a clean JSON file, offering full control over the simulation.
-   **Robust Concatenation**: After simulation, the script reliably concatenates all temporary sequence chunks into a final supermatrix, correctly handling missing taxa by filling in gaps with `?`.
-   **Automatic Cleanup**: All temporary files generated during the simulation are automatically deleted upon successful completion.

## Dependencies

The script requires Python 3 and the following libraries:
-   `pyvolve`
-   `Biopython`

## Installation

1.  **Create an environment (recommended):**
    
        conda create -n sim_env python=3.8
        conda activate sim_env

2.  **Install libraries using pip:**
    
        pip install pyvolve biopython

## Usage

The script is run from the command line, choosing either automatic (`-i`) or manual (`-p`) mode.

### Automatic Mode Example

This command simulates a dataset using parameters from `RAxML_info.txt` and the topology from `my_tree.nwk`. It will create 50 chunks of 100,000 bp each (totaling 5M bp) using 8 parallel processes.

    python your_script_name.py \
        -i RAxML_info.txt \
        -t my_tree.nwk \
        -r 50 \
        -c 100000 \
        -j 8

### Manual Mode Example

This command runs a similar simulation but uses model parameters defined in a custom `my_params.json` file.

    python your_script_name.py \
        -p my_params.json \
        -t my_tree.nwk \
        -r 50 \
        -c 100000 \
        -j 8

---

## Modes of Operation Explained

### Automatic Mode (-i)

This is the most straightforward way to use the script. You provide the information file generated by a RAxML-ng analysis (e.g., `RAxML_info.my_alignment.txt`). The script will automatically find the following GTR+GAMMA parameters from this file:
-   Alpha shape parameter for the Gamma distribution.
-   Equilibrium base frequencies (`pi(A)`, `pi(C)`, `pi(G)`, `pi(T)`).
-   The six substitution rates for the GTR model (`A<->C`, `A<->G`, etc.).

This mode is ideal for generating a null dataset that precisely matches the evolutionary model estimated from your empirical data.

### Manual Mode (-p)

This mode provides greater flexibility. Instead of a RAxML file, you provide a JSON file containing the model parameters. This is useful when:
-   You want to simulate data under a theoretical model, not one estimated from data.
-   Your parameters come from a source other than RAxML.
-   The automatic parsing of your RAxML file fails for any reason.

When automatic parsing fails, the script will create a `params_template.json` file with the correct structure, which you can then edit with your desired values.

---

## Command-Line Options

| Argument | Description |
|---|---|
| `-i`, `--info` | **(Automatic Mode)** Path to the info or log file generated by RAxML. |
| `-p`, `--params` | **(Manual Mode)** Path to a custom parameter file in JSON format. |
| `-t`, `--tree` | **(Required)** Path to the file containing a phylogenetic tree in Newick format. |
| `-r`, `--replicates` | Number of simulation chunks to generate. Default: `10`. |
| `-c`, `--chunk_size` | Sequence length (in bp) for each simulation chunk. Default: `100000`. |
| `-j`, `--jobs` | Number of parallel processes to use for simulation. Set to the number of available CPU cores for maximum speed. Default: `1`. |

> **Note**: The total length of the final simulated alignment will be `replicates` Ã— `chunk_size`.

## Input Files

### RAxML Info File
-   A standard info/log file produced by RAxML-ng that contains the results of a `GTR+GAMMA` model fit. The script specifically looks for plain-text reporting of `alpha`, `rate A <-> C`, and `freq pi(A)`, etc.

### Custom Parameters JSON File
-   A text file in JSON format specifying the model parameters. It must contain `alpha`, `state_freqs`, and `rates` keys. The structure should be as follows:

        {
            "alpha": 0.5,
            "state_freqs": [0.25, 0.25, 0.25, 0.25],
            "rates": {
                "AC": 1.0, 
                "AG": 1.0, 
                "AT": 1.0,
                "CG": 1.0, 
                "CT": 1.0, 
                "GT": 1.0
            }
        }

### Tree File
-   A standard Newick file containing a single phylogenetic tree with branch lengths. The taxon names in this tree will be the names of the sequences in the final output FASTA file.

## Output File

The script produces a single, concatenated FASTA file named using the pattern:
`simulated_supermatrix_from_<tree_filename>.fasta`

For example, if your input tree is `my_tree.nwk`, the output will be `simulated_supermatrix_from_my_tree.fasta`. This file contains the complete simulated alignment for all taxa present in the input tree.
